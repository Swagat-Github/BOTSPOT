!function(W){function n(e,t){var i=this,r=W.extend({},W.fn.signaturePad.defaults,t),o=W(e),n=W(r.canvas,o),s=n.get(0),l=null,u={x:null,y:null},d=[],c=!1,a=!1,p=!1,f=!1,h=30,g=h,v=0;function m(){clearTimeout(c),a=c=!1}function y(e,t){var n,a;if(e.preventDefault(),n=W(e.target).offset(),clearTimeout(c),c=!1,e=void 0!==e.targetTouches?(a=Math.floor(e.targetTouches[0].pageX-n.left),Math.floor(e.targetTouches[0].pageY-n.top)):(a=Math.floor(e.pageX-n.left),Math.floor(e.pageY-n.top)),u.x===a&&u.y===e)return!0;null===u.x&&(u.x=a),null===u.y&&(u.y=e),t&&(e+=t),l.beginPath(),l.moveTo(u.x,u.y),l.lineTo(a,e),l.lineCap=r.penCap,l.stroke(),l.closePath(),d.push({lx:a,ly:e,mx:u.x,my:u.y}),u.x=a,u.y=e,r.onDraw&&"function"==typeof r.onDraw&&r.onDraw.apply(i)}function w(){C()}function C(){f=!1,u={x:null,y:null},p?n.each(function(){this.removeEventListener("touchmove",y)}):n.unbind("mousemove.signaturepad"),r.output&&0<d.length&&W(r.output,o).val(JSON.stringify(d)),0<d.length&&r.onDrawEnd&&"function"==typeof r.onDrawEnd&&r.onDrawEnd.apply(i)}function b(){l.clearRect(0,0,s.width,s.height),l.fillStyle=r.bgColour,l.fillRect(0,0,s.width,s.height),r.displayOnly||r.lineWidth&&(l.beginPath(),l.lineWidth=r.lineWidth,l.strokeStyle=r.lineColour,l.moveTo(r.lineMargin,r.lineTop),l.lineTo(s.width-r.lineMargin,r.lineTop),l.stroke(),l.closePath()),l.lineWidth=r.penWidth,l.strokeStyle=r.penColour,W(r.output,o).val(""),d=[],C()}function I(e,t){null==u.x?y(e,1):y(e,t)}function x(e,t){p?t.addEventListener("touchmove",I,!1):n.bind("mousemove.signaturepad",I),y(e,1)}function D(e){f||(p=!(f=!0),W("input").blur(),(p=void 0!==e.targetTouches?!0:p)?n.each(function(){this.addEventListener("touchend",w,!1),this.addEventListener("touchcancel",w,!1)}):(W(document).bind("mouseup.signaturepad",function(){a&&(C(),m())}),n.bind("mouseleave.signaturepad",function(e){a&&C(),a&&!c&&(c=setTimeout(function(){C(),m()},500))})))}function E(e){e.preventDefault(),a=!0,D(e),x(e,this)}function k(){W(r.typed,o).hide(),b(),n.each(function(){this.addEventListener("touchstart",E)}),n.bind("mousedown.signaturepad",function(e){if(e.preventDefault(),1<e.which)return!1;a=!0,D(e),x(e)}),W(r.clear,o).bind("click.signaturepad",function(e){e.preventDefault(),b()}),W(r.typeIt,o).bind("click.signaturepad",function(e){e.preventDefault(),O()}),W(r.drawIt,o).unbind("click.signaturepad"),W(r.drawIt,o).bind("click.signaturepad",function(e){e.preventDefault()}),W(r.typeIt,o).removeClass(r.currentClass),W(r.drawIt,o).addClass(r.currentClass),W(r.sig,o).addClass(r.currentClass),W(r.typeItDesc,o).hide(),W(r.drawItDesc,o).show(),W(r.clear,o).show()}function O(){b(),f=!1,n.each(function(){this.removeEventListener&&(this.removeEventListener("touchend",w),this.removeEventListener("touchcancel",w),this.removeEventListener("touchmove",y),this.removeEventListener("touchstart",E))}),W(document).unbind("mouseup.signaturepad"),n.unbind("mousedown.signaturepad"),n.unbind("mousemove.signaturepad"),n.unbind("mouseleave.signaturepad"),W(r.clear,o).unbind("click.signaturepad"),W(r.typed,o).show(),W(r.drawIt,o).bind("click.signaturepad",function(e){e.preventDefault(),k()}),W(r.typeIt,o).unbind("click.signaturepad"),W(r.typeIt,o).bind("click.signaturepad",function(e){e.preventDefault()}),W(r.output,o).val(""),W(r.drawIt,o).removeClass(r.currentClass),W(r.typeIt,o).addClass(r.currentClass),W(r.sig,o).removeClass(r.currentClass),W(r.drawItDesc,o).hide(),W(r.clear,o).hide(),W(r.typeItDesc,o).show(),g=h=W(r.typed,o).css("font-size").replace(/px/,"")}function P(e){var t=W(r.typed,o),e=W.trim(e.replace(/>/g,"&gt;").replace(/</g,"&lt;")),n=v,a=.5*g;if(v=e.length,t.html(e),e){if(n<v&&t.outerWidth()>s.width)for(;4<g&&t.outerWidth()>s.width;)g--,t.css("font-size",g+"px");if(v<n&&t.outerWidth()+a<s.width&&g<h)for(;g<512&&t.outerWidth()+a<s.width&&g<h;)g++,t.css("font-size",g+"px")}else t.css("font-size",h+"px")}function T(){var e=!0,t={drawInvalid:!1,nameInvalid:!1},n=[o,r],a=[t,o,r];return(r.onBeforeValidate&&"function"==typeof r.onBeforeValidate?r.onBeforeValidate:function(e,t){W("p."+t.errorClass,e).remove(),e.removeClass(t.errorClass),W("input, label",e).removeClass(t.errorClass)}).apply(i,n),r.drawOnly&&d.length<1&&(e=!(t.drawInvalid=!0)),""===W(r.name,o).val()&&(e=!(t.nameInvalid=!0)),(r.onFormError&&"function"==typeof r.onFormError?r.onFormError:function(e,t,n){e.nameInvalid&&(t.prepend(['<p class="',n.errorClass,'">',n.errorMessage,"</p>"].join("")),W(n.name,t).focus(),W(n.name,t).addClass(n.errorClass),W("label[for="+W(n.name).attr("id")+"]",t).addClass(n.errorClass)),e.drawInvalid&&t.prepend(['<p class="',n.errorClass,'">',n.errorMessageDraw,"</p>"].join(""))}).apply(i,a),e}function S(e,t,n){for(var a in e)"object"==typeof e[a]&&(t.beginPath(),t.moveTo(e[a].mx,e[a].my),t.lineTo(e[a].lx,e[a].ly),t.lineCap=r.penCap,t.stroke(),t.closePath(),n&&e[a].lx&&d.push({lx:e[a].lx,ly:e[a].ly,mx:e[a].mx,my:e[a].my}))}W.extend(i,{signaturePad:"{{version}}",init:function(){parseFloat((/CPU.+OS ([0-9_]{3}).*AppleWebkit.*Mobile/i.exec(navigator.userAgent)||[0,"4_2"])[1].replace("_","."))<4.1&&(W.fn.Oldoffset=W.fn.offset,W.fn.offset=function(){var e=W(this).Oldoffset();return e.top-=window.scrollY,e.left-=window.scrollX,e}),W(r.typed,o).bind("selectstart.signaturepad",function(e){return W(e.target).is(":input")}),n.bind("selectstart.signaturepad",function(e){return W(e.target).is(":input")}),!s.getContext&&FlashCanvas&&FlashCanvas.initElement(s),s.getContext&&(l=s.getContext("2d"),W(r.sig,o).show(),r.displayOnly||(r.drawOnly||(W(r.name,o).bind("keyup.signaturepad",function(){P(W(this).val())}),W(r.name,o).bind("blur.signaturepad",function(){P(W(this).val())}),W(r.drawIt,o).bind("click.signaturepad",function(e){e.preventDefault(),k()})),(r.drawOnly||"drawIt"===r.defaultAction?k:O)(),r.validateFields&&(W(e).is("form")?W(e):W(e).parents("form")).bind("submit.signaturepad",T),W(r.sigNav,o).show()))},updateOptions:function(e){W.extend(r,e)},regenerate:function(e){i.clearCanvas(),W(r.typed,o).hide(),S(e="string"==typeof e?JSON.parse(e):e,l,!0),r.output&&0<W(r.output,o).length&&W(r.output,o).val(JSON.stringify(d))},clearCanvas:function(){b()},getSignature:function(){return d},getSignatureString:function(){return JSON.stringify(d)},getSignatureImage:function(){var e=document.createElement("canvas"),t=null;return e.style.position="absolute",e.style.top="-999em",e.width=s.width,e.height=s.height,document.body.appendChild(e),!e.getContext&&FlashCanvas&&FlashCanvas.initElement(e),(t=e.getContext("2d")).fillStyle=r.bgColour,t.fillRect(0,0,s.width,s.height),t.lineWidth=r.penWidth,t.strokeStyle=r.penColour,S(d,t),t=e.toDataURL.apply(e,arguments),document.body.removeChild(e),e=null,t},validateForm:T})}W.fn.signaturePad=function(e){var t=null;return this.each(function(){W.data(this,"plugin-signaturePad")?(t=W.data(this,"plugin-signaturePad")).updateOptions(e):((t=new n(this,e)).init(),W.data(this,"plugin-signaturePad",t))}),t},W.fn.signaturePad.defaults={defaultAction:"typeIt",displayOnly:!1,drawOnly:!1,canvas:"canvas",sig:".sig",sigNav:".sigNav",bgColour:"#ffffff",penColour:"#145394",penWidth:2,penCap:"round",lineColour:"#ccc",lineWidth:2,lineMargin:5,lineTop:35,name:".name",typed:".typed",clear:".clearButton",typeIt:".typeIt a",drawIt:".drawIt a",typeItDesc:".typeItDesc",drawItDesc:".drawItDesc",output:".output",currentClass:"current",validateFields:!0,errorClass:"error",errorMessage:"Please enter your name",errorMessageDraw:"Please sign the document",onBeforeValidate:null,onFormError:null,onDraw:null,onDrawEnd:null}}(jQuery);